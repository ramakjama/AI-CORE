apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: ai-core
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: monitoring
data:
  ai-core-alerts.yml: |
    groups:
      - name: ai-core-api
        rules:
          # High Error Rate
          - alert: HighErrorRate
            expr: |
              sum(rate(http_requests_total{job="ai-core-api",status=~"5.."}[5m])) /
              sum(rate(http_requests_total{job="ai-core-api"}[5m])) > 0.05
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High error rate detected"
              description: "Error rate is {{ $value | humanizePercentage }} for the last 5 minutes"

          # High Latency
          - alert: HighLatency
            expr: |
              histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="ai-core-api"}[5m])) by (le)) > 2
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High latency detected"
              description: "95th percentile latency is {{ $value }}s"

          # Pod Crash Loop
          - alert: PodCrashLooping
            expr: |
              rate(kube_pod_container_status_restarts_total{namespace="ai-core"}[15m]) > 0
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: "Pod {{ $labels.pod }} is crash looping"
              description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently"

          # High CPU Usage
          - alert: HighCPUUsage
            expr: |
              sum(rate(container_cpu_usage_seconds_total{namespace="ai-core"}[5m])) by (pod) /
              sum(kube_pod_container_resource_limits{namespace="ai-core",resource="cpu"}) by (pod) > 0.9
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage on pod {{ $labels.pod }}"
              description: "CPU usage is {{ $value | humanizePercentage }}"

          # High Memory Usage
          - alert: HighMemoryUsage
            expr: |
              sum(container_memory_working_set_bytes{namespace="ai-core"}) by (pod) /
              sum(kube_pod_container_resource_limits{namespace="ai-core",resource="memory"}) by (pod) > 0.9
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage on pod {{ $labels.pod }}"
              description: "Memory usage is {{ $value | humanizePercentage }}"

      - name: ai-core-database
        rules:
          # PostgreSQL Down
          - alert: PostgreSQLDown
            expr: pg_up == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "PostgreSQL is down"
              description: "PostgreSQL instance is not responding"

          # High Connection Count
          - alert: PostgreSQLHighConnections
            expr: |
              pg_stat_activity_count / pg_settings_max_connections > 0.8
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High PostgreSQL connection count"
              description: "Connection count is {{ $value | humanizePercentage }} of max"

          # Slow Queries
          - alert: PostgreSQLSlowQueries
            expr: |
              rate(pg_stat_statements_seconds_total[5m]) > 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Slow PostgreSQL queries detected"
              description: "Average query time is {{ $value }}s"

          # Redis Down
          - alert: RedisDown
            expr: redis_up == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Redis is down"
              description: "Redis instance is not responding"

          # Redis High Memory
          - alert: RedisHighMemory
            expr: |
              redis_memory_used_bytes / redis_memory_max_bytes > 0.9
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Redis memory usage high"
              description: "Memory usage is {{ $value | humanizePercentage }}"

      - name: ai-core-messaging
        rules:
          # Kafka Consumer Lag
          - alert: KafkaConsumerLag
            expr: |
              kafka_consumer_group_lag > 10000
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "Kafka consumer lag high"
              description: "Consumer group {{ $labels.group }} has lag of {{ $value }}"

          # NATS Connection Issues
          - alert: NATSConnectionIssues
            expr: |
              nats_connz_connections < 1
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "NATS has no connections"
              description: "NATS server has {{ $value }} active connections"

      - name: ai-core-infrastructure
        rules:
          # Disk Space Low
          - alert: DiskSpaceLow
            expr: |
              (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Disk space low on {{ $labels.instance }}"
              description: "Available disk space is {{ $value | humanizePercentage }}"

          # Node Not Ready
          - alert: NodeNotReady
            expr: |
              kube_node_status_condition{condition="Ready",status="true"} == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Node {{ $labels.node }} is not ready"
              description: "Node has been not ready for more than 5 minutes"

          # PVC Almost Full
          - alert: PVCAlmostFull
            expr: |
              kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes > 0.85
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "PVC {{ $labels.persistentvolumeclaim }} is almost full"
              description: "PVC usage is {{ $value | humanizePercentage }}"

  recording-rules.yml: |
    groups:
      - name: ai-core-recording
        rules:
          # Request rate
          - record: job:http_requests_total:rate5m
            expr: sum(rate(http_requests_total[5m])) by (job)

          # Error rate
          - record: job:http_request_errors_total:rate5m
            expr: sum(rate(http_requests_total{status=~"5.."}[5m])) by (job)

          # Latency percentiles
          - record: job:http_request_duration_seconds:p50
            expr: histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))

          - record: job:http_request_duration_seconds:p95
            expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))

          - record: job:http_request_duration_seconds:p99
            expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))

          # CPU usage
          - record: namespace:container_cpu_usage_seconds_total:sum_rate
            expr: sum(rate(container_cpu_usage_seconds_total{namespace="ai-core"}[5m])) by (namespace)

          # Memory usage
          - record: namespace:container_memory_working_set_bytes:sum
            expr: sum(container_memory_working_set_bytes{namespace="ai-core"}) by (namespace)
