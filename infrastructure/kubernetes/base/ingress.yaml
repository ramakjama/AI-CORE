apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ai-core-ingress
  namespace: ai-core
  labels:
    app.kubernetes.io/name: ai-core
    app.kubernetes.io/component: ingress
  annotations:
    # Ingress Class
    kubernetes.io/ingress.class: nginx

    # SSL/TLS Configuration
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # Cert-Manager (Let's Encrypt)
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

    # Rate Limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # Proxy Configuration
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"

    # Security Headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.aicore.io wss://api.aicore.io;" always;

    # CORS Configuration
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://app.aicore.io,https://admin.aicore.io"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Authorization, Content-Type, X-Requested-With, X-Tenant-ID"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # WebSocket Support
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - api.aicore.io
        - app.aicore.io
        - admin.aicore.io
      secretName: ai-core-tls
  rules:
    # API Service
    - host: api.aicore.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ai-core-api
                port:
                  number: 3000
    # Web Application
    - host: app.aicore.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ai-core-web
                port:
                  number: 3000
    # Admin Dashboard
    - host: admin.aicore.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ai-core-web
                port:
                  number: 3000
---
# Internal Ingress for Monitoring (Restricted Access)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ai-core-monitoring-ingress
  namespace: ai-core
  labels:
    app.kubernetes.io/name: ai-core
    app.kubernetes.io/component: monitoring-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

    # Basic Auth for Monitoring
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: monitoring-basic-auth
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"

    # IP Whitelist (optional - configure your allowed IPs)
    # nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,192.168.0.0/16"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - grafana.aicore.io
        - prometheus.aicore.io
      secretName: ai-core-monitoring-tls
  rules:
    # Grafana
    - host: grafana.aicore.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000
    # Prometheus
    - host: prometheus.aicore.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus
                port:
                  number: 9090
---
# IngressClass (if not already created)
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: nginx
  annotations:
    ingressclass.kubernetes.io/is-default-class: "true"
spec:
  controller: k8s.io/ingress-nginx
---
# Basic Auth Secret for Monitoring
# Generate with: htpasswd -c auth admin
# Then: kubectl create secret generic monitoring-basic-auth --from-file=auth -n ai-core
apiVersion: v1
kind: Secret
metadata:
  name: monitoring-basic-auth
  namespace: ai-core
type: Opaque
stringData:
  # admin:password (change in production!)
  # Generate with: htpasswd -nb admin your-password | base64
  auth: |
    admin:$apr1$CHANGE_ME$HASH_GOES_HERE
