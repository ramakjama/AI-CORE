# ====================================
# AIT-CORE PRODUCTION OVERRIDES
# ====================================
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

version: '3.8'

services:
  # ====================================
  # INFRASTRUCTURE OVERRIDES
  # ====================================

  postgres:
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      # Production performance tuning
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=2GB"
      - "-c"
      - "effective_cache_size=6GB"
      - "-c"
      - "maintenance_work_mem=512MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=10MB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
      - "-c"
      - "max_worker_processes=8"
      - "-c"
      - "max_parallel_workers_per_gather=4"
      - "-c"
      - "max_parallel_workers=8"
      - "-c"
      - "max_parallel_maintenance_workers=4"
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  redis:
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 2gb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  elasticsearch:
    environment:
      - "ES_JAVA_OPTS=-Xms2g -Xmx4g"
      - xpack.security.enabled=true
      - xpack.security.authc.api_key.enabled=true
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 6G
        reservations:
          cpus: '2'
          memory: 4G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  minio:
    environment:
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_URL}
      MINIO_SERVER_URL: ${MINIO_SERVER_URL}
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  kafka:
    environment:
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://${KAFKA_HOST:-kafka}:9092
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_NUM_PARTITIONS: 6
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_MIN_INSYNC_REPLICAS: 1
      KAFKA_COMPRESSION_TYPE: lz4
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ====================================
  # FASTAPI SERVICES PRODUCTION CONFIG
  # ====================================

  auth-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []  # Remove volume mounts in production
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8000", "--access-logfile", "-", "--error-logfile", "-"]
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  storage-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8001"]
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  documents-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8002", "--timeout", "300"]
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  mail-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      IMAP_PASSWORD: ${IMAP_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8003"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  calendar-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8004"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  tasks-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8005"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  crm-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8006"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  analytics-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "6", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8007", "--timeout", "300"]
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  hr-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      PAYROLL_ENCRYPTION_KEY: ${PAYROLL_ENCRYPTION_KEY}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8008"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  workflow-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8009"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  collaboration-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      WEBSOCKET_URL: ${WEBSOCKET_URL}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8010"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  spreadsheets-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8011"]
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  presentations-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8012"]
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  forms-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8013"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  notes-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8014"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  bookings-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8015"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  assistant-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8016", "--timeout", "300"]
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  whiteboard-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8017"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  translator-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      DEEPL_API_KEY: ${DEEPL_API_KEY}
      GOOGLE_TRANSLATE_API_KEY: ${GOOGLE_TRANSLATE_API_KEY}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8018"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  embedded-apps-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "4", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8019"]
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  gateway-service:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      CORS_ORIGINS: ${CORS_ORIGINS}
    volumes: []
    command: ["python", "-m", "gunicorn", "src.main:app", "--workers", "6", "--worker-class", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8020"]
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
      replicas: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ====================================
  # NODE.JS SERVICES PRODUCTION CONFIG
  # ====================================

  ait-pgc-engine:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      JWT_SECRET: ${JWT_SECRET}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    volumes: []
    command: npm run start:prod
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  api-gateway:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGIN: ${CORS_ORIGINS}
    volumes: []
    command: npm run start:prod
    deploy:
      replicas: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  ait-accountant:
    environment:
      NODE_ENV: production
      LOG_LEVEL: warning
      JWT_SECRET: ${JWT_SECRET}
      PGC_ENGINE_API_KEY: ${PGC_ENGINE_API_KEY}
    volumes: []
    command: npm run start:prod
    deploy:
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  collaboration-ws:
    environment:
      NODE_ENV: production
      DEBUG: "false"
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ====================================
  # MONITORING SERVICES
  # ====================================

  prometheus:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  grafana:
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ====================================
  # NGINX REVERSE PROXY (Production only)
  # ====================================

  nginx:
    image: nginx:alpine
    container_name: ait-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
    depends_on:
      - gateway-service
      - api-gateway
    networks:
      - ait-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

# Additional production volumes
volumes:
  nginx_cache:
    driver: local
  nginx_logs:
    driver: local

# No changes to networks in production
